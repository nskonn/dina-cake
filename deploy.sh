#!/bin/bash
set -e

# –ü—É—Ç—å, –∫—É–¥–∞ –∫–ª–æ–Ω–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ–µ–∫—Ç
PROJECT_DIR="/srv/dina-cake.webzella.ru/app"

echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –¥–ª—è dina-cake.webzella.ru..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -d "$PROJECT_DIR" ]; then
  echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $PROJECT_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –°–æ–∑–¥–∞–π—Ç–µ –µ—ë –∏–ª–∏ —Å–º–µ–Ω–∏—Ç–µ –ø—É—Ç—å –≤ —Å–∫—Ä–∏–ø—Ç–µ."
  exit 1
fi

cd "$PROJECT_DIR"

echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ Git..."
if [ -d .git ]; then
  git pull origin main || true
else
  echo "‚ö†Ô∏è Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ –ø–∞–ø–∫–µ."
fi

echo "üì¶ –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
# –ò—Å–ø–æ–ª—å–∑—É–µ–º --remove-orphans, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –µ—Å–ª–∏ –∏–º–µ–Ω–∞ –ø–æ–º–µ–Ω—è–ª–∏—Å—å
docker compose down --remove-orphans
docker compose up -d --build

echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
docker ps | grep enduro